name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  java-build:
    name: Build and Test Java Server
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    - name: Make gradlew executable
      run: chmod +x gradlew
    
    - name: Build with Gradle
      run: ./gradlew clean build -x test
    
    - name: Run tests
      run: ./gradlew test
    
    - name: Build Quarkus app
      run: ./gradlew quarkusBuild
    
    - name: Upload Quarkus app artifact
      uses: actions/upload-artifact@v4.4.3
      with:
        name: quarkus-app
        path: build/quarkus-app/
        retention-days: 7

  python-clients:
    name: Build and Test Python Clients
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: clients/python/requirements.txt
    
    - name: Install dependencies
      working-directory: clients/python
      run: |
        pip install -r requirements.txt
    
    - name: Generate gRPC stubs
      working-directory: clients/python
      run: |
        ./generate_protos.sh
    
    - name: Validate Python syntax
      working-directory: clients/python
      run: |
        python3 -m py_compile unary_client.py
        python3 -m py_compile streaming_client.py
    
    - name: Upload Python clients
      uses: actions/upload-artifact@v4.4.3
      with:
        name: python-clients
        path: clients/python/
        retention-days: 7

  go-clients:
    name: Build and Test Go Clients
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'
        cache: true
        cache-dependency-path: clients/go/go.sum
    
    - name: Install protoc
      run: |
        wget -q https://github.com/protocolbuffers/protobuf/releases/download/v25.1/protoc-25.1-linux-x86_64.zip
        unzip -q protoc-25.1-linux-x86_64.zip -d $HOME/.local
        echo "$HOME/.local/bin" >> $GITHUB_PATH
    
    - name: Install Go protoc plugins
      run: |
        go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
        go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
    
    - name: Generate gRPC stubs
      working-directory: clients/go
      run: ./generate_protos.sh
    
    - name: Get dependencies
      working-directory: clients/go
      run: go mod download
    
    - name: Build Go clients
      working-directory: clients/go
      run: |
        go build -v -o unary_client unary_client.go
        go build -v -o streaming_client streaming_client.go
    
    - name: Vet Go clients
      working-directory: clients/go
      run: |
        go vet unary_client.go
        go vet streaming_client.go
    
    - name: Upload Go binaries
      uses: actions/upload-artifact@v4.4.3
      with:
        name: go-clients
        path: |
          clients/go/unary_client
          clients/go/streaming_client
        retention-days: 7

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [java-build, python-clients, go-clients]

    services:
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_DB: arena
          POSTGRES_USER: quarkus
          POSTGRES_PASSWORD: quarkus
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U quarkus -d arena"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Download Java artifact
      uses: actions/download-artifact@v4.1.3
      with:
        name: quarkus-app
        path: build/quarkus-app/

    - name: Download Python clients
      uses: actions/download-artifact@v4.1.3
      with:
        name: python-clients
        path: clients/python/

    - name: Download Go binaries
      uses: actions/download-artifact@v4.1.3
      with:
        name: go-clients
        path: clients/go/

    - name: Make binaries executable
      run: |
        chmod +x clients/go/unary_client
        chmod +x clients/go/streaming_client
        chmod +x clients/python/unary_client.py
        chmod +x clients/python/streaming_client.py

    - name: Install Python dependencies
      working-directory: clients/python
      run: pip install -r requirements.txt

    - name: Start Quarkus server in background
      run: |
        java -jar build/quarkus-app/quarkus-run.jar &
        echo $! > server.pid
        # Wait for server to start
        for i in $(seq 1 30); do
          if curl -so /dev/null -w '%{http_code}' http://localhost:8080/ 2>/dev/null | grep -qE '(200|404)'; then
            echo "Server is ready"
            break
          fi
          echo "Waiting for server... ($i/30)"
          sleep 2
        done
        # Verify the HTTP/gRPC port is listening
        timeout 5 bash -c 'cat < /dev/tcp/localhost/8080' 2>/dev/null || true
    
    - name: Test Python Unary Client
      timeout-minutes: 2
      run: |
        cd clients/python
        python3 unary_client.py --host localhost --port 8080 &
        CLIENT1_PID=$!
        sleep 1
        python3 unary_client.py --host localhost --port 8080 &
        CLIENT2_PID=$!
        wait $CLIENT1_PID
        wait $CLIENT2_PID
    
    - name: Test Go Unary Client
      timeout-minutes: 2
      run: |
        cd clients/go
        ./unary_client -host localhost -port 8080 &
        CLIENT1_PID=$!
        sleep 1
        ./unary_client -host localhost -port 8080 &
        CLIENT2_PID=$!
        wait $CLIENT1_PID
        wait $CLIENT2_PID
    
    - name: Stop server
      if: always()
      run: |
        if [ -f server.pid ]; then
          kill $(cat server.pid) || true
        fi

  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [java-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Download Java artifact
      uses: actions/download-artifact@v4.1.3
      with:
        name: quarkus-app
        path: build/quarkus-app/
    
    - name: Build Docker image
      run: |
        docker build -f src/main/docker/Dockerfile.jvm -t paper-rock-scissors-arena:latest .
    
    - name: Save Docker image
      run: |
        docker save paper-rock-scissors-arena:latest | gzip > paper-rock-scissors-arena.tar.gz
    
    - name: Upload Docker image
      uses: actions/upload-artifact@v4.4.3
      with:
        name: docker-image
        path: paper-rock-scissors-arena.tar.gz
        retention-days: 7
